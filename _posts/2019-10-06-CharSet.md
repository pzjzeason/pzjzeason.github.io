---
layout: post
title: 字符集，以及python中的字符串
date: 2019-10-06
---
一直对字符编码半生不熟，抽空理清了一下各种概念，再弄不混encode和decode了。
### Basic concepts
1. ASCII: 美国标准字符集，最早的英文字符集，而来还扩展了127～256
2. GB2312: 中文字符集，两个大于127(A1~F7)的字节表示汉字，小于128的与ASCII相同，收录7000个左右字符
3. GBK：兼容GB2312，收纳了不常见字符，原本GB2312汉字第二个字节不再要求大于127，也就是遇到大于127的字节得加上后面一个字节表示一个汉字,增加了两万个左右字符
4. GB18030：兼容GBK，增加2000多少数民族字符
5. unicode：国际统一编码，兼容ASCII。各国编码互不兼容就有了unicode。一共有17组编排（plane），每组2^16=65536个码点，第一个plane是基本多文种平面，包含各国文字。第二个plane是补充平面，emoji在里面。
6. 一个unicode字符在传输或者保存时需要编码，而不是直接将码数直接转成二进制保存。原因如下：
    - 每个平面需要2个字节即16位二进制，还需要用额外的5位标示17个不同的平面，共21位。实际传输都是以字节为单位，所以要三个字节来表示每一个字符。
    - 而绝大部分的文本数据都是西文的，原本ASCII一个字节就能保存，现在需要三个字节，前两个字节都为0，造成了极大的浪费。于是有了utf-8等unicode的实现方式，使得原本的ASCII仅占一个字节。
7. unicode编码的实现主要有utf-8和utf-16，将unicode的码点序列编码已传输和保存。这两种实现方式都是变长字节的，原本的ASCII占一个字节，中文占2～4个字节，常用的汉字一般占3个字节。
8. 从unicode到utf-8的转换规则是通过一定算法的，对于计算机来说很简单。具体规则如下：
    ![d](https://file.gsxservice.com/um-static/6b0ca749/utf8.png)
9. 举例来说："中"是unicode基本平面的第20013个码点（`U+20013`），20013直接表示成二进制是：`0100111000101101`，16进制是：`4e2d`。它属于U+0080到U+07FF区域，也就是说被表示成三个字节：`1110xxxx,10yyyyyy,10zzzzzz`。将20013的二进制拆除三部分：`0100,111000,101101`依次填充到xyz中得到其utf-8编码：`11100100,10111000,10101101`，表示成16进制就是`e4b8ad`.
### String in Python
对于单个字符的编码，Python提供了ord()函数获取字符的整数表示，chr()函数把编码转换为对应的字符。
#### 表示
```python
>>> ord('A')
65
>>> ord('中')
20013
>>> chr(66)
'B'
>>> chr(25991)
'文'
```
Python的字符串类型是str，在内存中以Unicode表示。比如"中"是unicode基本平面的20013个码点，20013直接表示成16进制是：4e2d。
```python
>>> '\u4e2d'
'中'
```
\u表示unicode码数。

#### 编码和解码
unicode形式的字符串需要编码成utf-8(or uft-16, not common)进行传输,也就是字节，即python中的bytes类型。例如："中"被utf-8编码成`11100100,10111000,10101101`,16进制`e4b8ad`，在python中表示成`b'\xe4\xb8\xad'`，三个字节。在bytes中，一个字节无法显示为ASCII字符，用\x##显示。ASCII转成字节类型，内容不变。
```python
>>> 'ABC'.encode('ascii')
b'ABC'
>>> 'ABC'.encode('utf-8')
b'ABC'
>>> '中'.encode('utf-8')
b'\xe4\xb8\xad'
```

反过来，如果我们从网络或磁盘上读取了字节流，那么读到的数据就是bytes。要把bytes变为str，就需要用decode()方法：
```python
>>> b'ABC'.decode('ascii')
'ABC'
>>> b'\xe4\xb8\xad'.decode('utf-8')
'中'
```
总结来说：encode是将unicode编码成utf-8或者其他格式，字符串变长字节流；decode是将字节流恢复成字符串。两者需要采用相同的编码格式，否则非ASCII字符就乱码了。

#### 字符串长度 vs 字节长度
要计算str包含多少个字符，可以用len()函数：
```python
>>> len('ABC')
3
>>> len('中文')
2
```
len()函数计算的是str的字符数，如果换成bytes，len()函数就计算字节数：
```python
>>> len(b'ABC')
3
>>> len(b'\xe4\xb8\xad\xe6\x96\x87')
6
>>> len('中文'.encode('utf-8'))
6
```
